---
title: "Pooled interaction models with formal tests"
author: "Jae Yeon Kim"
output:
  html_document:
    toc: true
    theme: united
---

# Setup

```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        glue, # putting strings and objects together
        patchwork, # putting ggplots together
        conflicted, # for resolving conflicting functions
        here, # for self-contained projects
        ggpubr, # for pub-ready themes
        estimatr, # stat modeling
        modelsummary, # regression tables
        kableExtra, # table formatting
        purrr, # for functional programming
        marginaleffects # for marginal effects and contrasts
)

# Resolve conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

# Publication-friendly theme
theme_set(theme_pubr(base_size = 10))

source(here("functions", "utils.r"))
source(here("functions", "theme_publications.r"))
```

# Data

```{r}
df <- read.csv(here("processed_data", "augmented_df.csv"))#[,-1]

# Filter Multiracial and relevel race with Black as reference
df <- df %>%
  filter(race != "Multiracial") %>%
  mutate(race = relevel(factor(race), ref = "Black"))

# Sample sizes by race
table(df$race)
```

# Fit pooled interaction models

```{r}
# DVs by family
dvs_lf <- c("linkedfate_race")
dvs_comm <- c("commrace", "commcult", "commecon", "commpol")
dvs_fed <- c("inequality", "bank_reg", "minimum_wage", "rich_tax", "free_college")
all_dvs <- c(dvs_lf, dvs_comm, dvs_fed)

# DV labels
dv_labels <- c(
  "linkedfate_race" = "Linked fate (racial)",
  "commrace" = "Racial commonality",
  "commcult" = "Cultural commonality",
  "commecon" = "Economic commonality",
  "commpol" = "Political commonality",
  "inequality" = "Reducing inequality",
  "bank_reg" = "Regulating banks",
  "minimum_wage" = "Minimum wage",
  "rich_tax" = "Taxing the rich",
  "free_college" = "Free college"
)

# Fit all models

# Unweighted
models_unweighted <- map(all_dvs, ~ols_interaction(df, .x)) %>%
  set_names(all_dvs)
  
# Weighted
models_weighted <- map(all_dvs, ~ols_interaction(df, .x, weights = "weight")) %>%
  set_names(all_dvs)
```

# Regression tables

```{r}
# Coefficient map for clean labels
coef_map <- c(
  "discrimination" = "Discrimination",
  "micro_aggression" = "Micro-aggression",
  "raceAAPI" = "AAPI",
  "raceLatino" = "Latino",
  "raceWhite" = "White",
  "discrimination:raceAAPI" = "Discrimination × AAPI",
  "discrimination:raceLatino" = "Discrimination × Latino",
  "discrimination:raceWhite" = "Discrimination × White",
  "micro_aggression:raceAAPI" = "Micro-aggression × AAPI",
  "micro_aggression:raceLatino" = "Micro-aggression × Latino",
  "micro_aggression:raceWhite" = "Micro-aggression × White",
  "age" = "Age",
  "educ6" = "Education",
  "income" = "Income",
  "ownhome" = "Homeownership",
  "male" = "Male",
  "forborn" = "Foreign born",
  "democrat" = "Democrat",
  "republican" = "Republican"
)
```

## Linked fate

```{r}
# --- UNWEIGHTED Tables ---
# Linked fate
modelsummary(
  models_unweighted[dvs_lf],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Linked fate (Unweighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_lf_unweighted.html")
)
# Comm
modelsummary(
  models_unweighted[dvs_comm],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Community commonality (Unweighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_comm_unweighted.html")
)
# Fed
modelsummary(
  models_unweighted[dvs_fed],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Federal policy attitudes (Unweighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_fed_unweighted.html")
)

# --- WEIGHTED Tables ---
# Linked fate
modelsummary(
  models_weighted[dvs_lf],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Linked fate (Weighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_lf_weighted.html")
)
# Comm
modelsummary(
  models_weighted[dvs_comm],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Community commonality (Weighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_comm_weighted.html")
)
# Fed
modelsummary(
  models_weighted[dvs_fed],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Federal policy attitudes (Weighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_fed_weighted.html")
)
```

# Marginal effects plots

```{r fig.width=10, fig.height=6}
# Compute marginal effects 
marginal_df_unweighted <- map2_dfr(models_unweighted, names(models_unweighted), function(m, dv) {
  compute_marginal_effects(m) %>%
    mutate(dv = dv_labels[dv])
})

marginal_df_weighted <- map2_dfr(models_weighted, names(models_weighted), function(m, dv) {
  compute_marginal_effects(m) %>%
    mutate(dv = dv_labels[dv])
})
```

```{r}
# Plot function by DV family (using estimated marginal effects)
plot_me_family_df <- function(marginal_df, dv_ids, dv_labels, title, ncol = 2) {
  dv_subset <- unname(dv_labels[dv_ids])

  marginal_df %>%
    filter(dv %in% dv_subset) %>%
    mutate(
      dv = factor(dv, levels = dv_subset),
      race = factor(race, levels = c("Black", "AAPI", "Latino", "White"))
    ) %>%
    ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term)) +
    geom_pointrange(position = position_dodge(width = 0.4), size = 0.6) +
    geom_hline(yintercept = 0, linetype = "dotted") +
    coord_flip() +
    facet_wrap(~dv, scales = "free_x", ncol = ncol) +
    scale_colour_Publication() +
    theme_Publication(base_size = 10) +
    labs(
      title = title,
      subtitle = "Estimated marginal effects (main + interaction) by race",
      x = "Race", y = "Marginal effect estimate", color = "IV",
      caption = "Source: National Asian American Survey (2016)"
    )
}

# --- UNWEIGHTED Visualizations ---
p_lf_un <- plot_me_family_df(
  marginal_df_unweighted,
  dvs_lf,
  dv_labels,
  "Linked fate (Unweighted)",
  ncol = 1
)

ggsave(
  here("outputs", "marginal_lf_unweighted.png"),
  p_lf_un,
  width = 8,
  height = 4
)

p_comm_un <- plot_me_family_df(
  marginal_df_unweighted,
  dvs_comm,
  dv_labels,
  "Community commonality (Unweighted)",
  ncol = 2
)

ggsave(
  here("outputs", "marginal_comm_unweighted.png"),
  p_comm_un,
  width = 10,
  height = 6
)

p_fed_un <- plot_me_family_df(
  marginal_df_unweighted,
  dvs_fed,
  dv_labels,
  "Federal policy attitudes (Unweighted)",
  ncol = 3
)

ggsave(
  here("outputs", "marginal_fed_unweighted.png"),
  p_fed_un,
  width = 12,
  height = 6
)

# --- WEIGHTED Visualizations ---
lf_unweighted_df <- marginal_df_unweighted %>%
  filter(dv %in% dv_labels[dvs_lf]) %>%
  mutate(
    race = factor(race, levels = c("Black", "AAPI", "Latino", "White")),
    term = factor(term, levels = c("Discrimination", "Micro-aggression"))
  )

p_lf <- lf_unweighted_df %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term, shape = term)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_errorbar(
    position = position_dodge(width = 0.45),
    width = 0.12,
    linewidth = 0.7
  ) +
  geom_point(
    position = position_dodge(width = 0.45),
    size = 2.8
  ) +
  geom_label(
    aes(label = sprintf("%.2f", estimate)),
    position = position_dodge(width = 0.45),
    nudge_y = 0.045,
    size = 3.1,
    fill = "white",
    alpha = 0.9,
    label.size = 0,
    show.legend = FALSE
  ) +
  coord_cartesian(ylim = c(-0.02, 0.5)) +
  scale_color_grey(start = 0.2, end = 0.6) +
  theme_Publication(base_size = 11) +
  theme(legend.position = "bottom") +
  labs(
    title = "Marginal effects by race (unweighted)",
    subtitle = "IVs are discrimination and micro-aggression composites from factor-analysis-informed item groupings",
    x = "Race", y = "Marginal effect estimate",
    color = "IV",
    shape = "IV",
    caption = "Controls: age, education, income, homeownership, gender, foreign born, partisanship; state fixed effects.\nSource: National Asian American Survey (2016)"
  )

ggsave(
  here("outputs", "marginal_lf.png"),
  p_lf,
  width = 10,
  height = 4.8
)

lf_weighted_df <- marginal_df_weighted %>%
  filter(dv %in% dv_labels[dvs_lf]) %>%
  mutate(
    race = factor(race, levels = c("Black", "AAPI", "Latino", "White")),
    term = factor(term, levels = c("Discrimination", "Micro-aggression"))
  )

p_lf_w <- lf_weighted_df %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term, shape = term)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_errorbar(
    position = position_dodge(width = 0.45),
    width = 0.12,
    linewidth = 0.7
  ) +
  geom_point(
    position = position_dodge(width = 0.45),
    size = 2.8
  ) +
  geom_label(
    aes(label = sprintf("%.2f", estimate)),
    position = position_dodge(width = 0.45),
    nudge_y = 0.045,
    size = 3.1,
    fill = "white",
    alpha = 0.9,
    label.size = 0,
    show.legend = FALSE
  ) +
  coord_cartesian(ylim = c(-0.02, 0.5)) +
  scale_color_grey(start = 0.2, end = 0.6) +
  theme_Publication(base_size = 11) +
  theme(legend.position = "bottom") +
  labs(
    title = "Marginal effects by race (weighted)",
    subtitle = "IVs are discrimination and micro-aggression composites from factor-analysis-informed item groupings",
    x = "Race", y = "Marginal effect estimate",
    color = "IV",
    shape = "IV",
    caption = "Controls: age, education, income, homeownership, gender, foreign born, partisanship; state fixed effects; survey weights.\nSource: National Asian American Survey (2016)"
  )

  ggsave(
  here("outputs", "marginal_lf_weighted.png"),
  p_lf_w,
  width = 10,
  height = 4.8
)

# Side-by-side comparison to make weighting differences explicit
lf_compare_df <- bind_rows(
  lf_unweighted_df %>% mutate(spec = "Unweighted"),
  lf_weighted_df %>% mutate(spec = "Weighted")
) %>%
  mutate(spec = factor(spec, levels = c("Unweighted", "Weighted")))

p_lf_compare <- lf_compare_df %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term, shape = term)) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_errorbar(
    position = position_dodge(width = 0.45),
    width = 0.12,
    linewidth = 0.7
  ) +
  geom_point(
    position = position_dodge(width = 0.45),
    size = 2.8
  ) +
  geom_label(
    aes(label = sprintf("%.2f", estimate)),
    position = position_dodge(width = 0.45),
    nudge_y = 0.045,
    size = 3.1,
    fill = "white",
    alpha = 0.9,
    label.size = 0,
    show.legend = FALSE
  ) +
  facet_wrap(~spec, ncol = 2) +
  coord_cartesian(ylim = c(-0.02, 0.5)) +
  scale_color_grey(start = 0.2, end = 0.6) +
  theme_Publication(base_size = 11) +
  theme(legend.position = "bottom") +
  labs(
    title = "Marginal effects by race: unweighted vs weighted",
    subtitle = "IVs are discrimination and micro-aggression composites from factor-analysis-informed item groupings",
    x = "Race", y = "Marginal effect estimate",
    color = "IV",
    shape = "IV",
    caption = "Controls: age, education, income, homeownership, gender, foreign born, partisanship; state fixed effects.\nWeighted panel additionally uses survey weights. Source: National Asian American Survey (2016)"
  )

ggsave(
  here("outputs", "marginal_lf_compare.png"),
  p_lf_compare,
  width = 14,
  height = 5.2
)

p_comm_w <- plot_me_family_df(
  marginal_df_weighted,
  dvs_comm,
  dv_labels,
  "Community commonality (Weighted)",
  ncol = 2
)

ggsave(
  here("outputs", "marginal_comm_weighted.png"),
  p_comm_w,
  width = 10,
  height = 6
)

p_fed_w <- plot_me_family_df(
  marginal_df_weighted,
  dvs_fed,
  dv_labels,
  "Federal policy attitudes (Weighted)",
  ncol = 3
)

ggsave(
  here("outputs", "marginal_fed_weighted.png"),
  p_fed_w,
  width = 12,
  height = 6
)

# Reader-facing policy preference figures (federal policy DVs only)
plot_policy_marginals <- function(marginal_df, title, weighted = FALSE, y_limits = c(-0.30, 0.30)) {
  cap <- if (weighted) {
    "Controls: age, education, income, homeownership, gender, foreign born, partisanship; state fixed effects; survey weights.\nSource: National Asian American Survey (2016)"
  } else {
    "Controls: age, education, income, homeownership, gender, foreign born, partisanship; state fixed effects.\nSource: National Asian American Survey (2016)"
  }

  marginal_df %>%
    filter(dv %in% unname(dv_labels[dvs_fed])) %>%
    mutate(
      race = factor(race, levels = c("Black", "AAPI", "Latino", "White")),
      dv = factor(dv, levels = unname(dv_labels[dvs_fed]))
    ) %>%
    ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term, shape = term)) +
    geom_hline(yintercept = 0, linetype = "dotted") +
    geom_errorbar(position = position_dodge(width = 0.45), width = 0.12, linewidth = 0.7) +
    geom_point(position = position_dodge(width = 0.45), size = 2.5) +
    geom_label(
      aes(label = sprintf("%.2f", estimate)),
      position = position_dodge(width = 0.45),
      nudge_y = 0.03,
      size = 2.8,
      fill = "white",
      alpha = 0.9,
      label.size = 0,
      show.legend = FALSE
    ) +
    facet_wrap(~dv, ncol = 3) +
    coord_cartesian(ylim = y_limits) +
    scale_color_grey(start = 0.2, end = 0.6) +
    theme_Publication(base_size = 11) +
    theme(legend.position = "bottom") +
    labs(
      title = title,
      subtitle = "IVs are discrimination and micro-aggression composites from factor-analysis-informed item groupings",
      x = "Race", y = "Marginal effect estimate",
      color = "IV", shape = "IV",
      caption = cap
    )
}

p_policy_unweighted <- plot_policy_marginals(
  marginal_df_unweighted,
  "Policy preferences: marginal effects by race (unweighted)",
  weighted = FALSE
)

ggsave(
  here("outputs", "marginal_policy_unweighted.png"),
  p_policy_unweighted,
  width = 12,
  height = 7
)

p_policy_weighted <- plot_policy_marginals(
  marginal_df_weighted,
  "Policy preferences: marginal effects by race (weighted)",
  weighted = TRUE
)

ggsave(
  here("outputs", "marginal_policy_weighted.png"),
  p_policy_weighted,
  width = 12,
  height = 7
)

# Policy preference coefficient comparison (weighted, additive models)
policy_terms <- c("discrimination", "micro_aggression", "democrat", "republican")
df_policy_aapi <- df %>% filter(race == "AAPI")

fit_policy_models <- function(df_in, weighted = TRUE) {
  map(dvs_fed, function(dv) {
    lm_robust(
      as.formula(paste0(
        dv, " ~ discrimination + micro_aggression + democrat + republican + ",
        "age + educ6 + income + ownhome + male + forborn"
      )),
      data = df_in,
      fixed_effects = ~states,
      weights = if (weighted) df_in$weight else NULL
    )
  }) %>% set_names(dvs_fed)
}

plot_policy_assoc <- function(models, title, weighted = TRUE) {
  coef_df <- map2_dfr(models, names(models), function(m, dv) {
    broom::tidy(m, conf.int = TRUE) %>%
      filter(term %in% policy_terms) %>%
      mutate(dv = dv_labels[dv])
  }) %>%
    mutate(
      term = recode(term,
        "discrimination" = "Discrimination",
        "micro_aggression" = "Micro-aggression",
        "democrat" = "Democrat",
        "republican" = "Republican"
      ),
      term = factor(term, levels = c("Discrimination", "Micro-aggression", "Democrat", "Republican")),
      dv = factor(dv, levels = unname(dv_labels[dvs_fed]))
    )

  lim <- range(c(coef_df$conf.low, coef_df$conf.high), na.rm = TRUE)
  pad <- 0.03
  cap <- if (weighted) {
    "AAPI subsample only. Predictors shown: discrimination, micro-aggression, democrat, republican. Controls: age, education, income, homeownership, gender, foreign born; state fixed effects; survey weights.\nSource: National Asian American Survey (2016)"
  } else {
    "AAPI subsample only. Predictors shown: discrimination, micro-aggression, democrat, republican. Controls: age, education, income, homeownership, gender, foreign born; state fixed effects.\nSource: National Asian American Survey (2016)"
  }

  coef_df %>%
    ggplot(aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high, color = term, shape = term)) +
    geom_hline(yintercept = 0, linetype = "dotted") +
    geom_errorbar(width = 0.12, linewidth = 0.7) +
    geom_point(size = 2.6) +
    geom_label(
      aes(label = sprintf("%.2f", estimate)),
      nudge_y = 0.02,
      size = 2.8,
      fill = "white",
      alpha = 0.9,
      label.size = 0,
      show.legend = FALSE
    ) +
    facet_wrap(~dv, ncol = 3) +
    coord_flip(ylim = c(lim[1] - pad, lim[2] + pad)) +
    scale_color_grey(start = 0.2, end = 0.7) +
    theme_Publication(base_size = 11) +
    theme(legend.position = "bottom") +
    labs(
      title = title,
      subtitle = "AAPI-only multivariable regression with state fixed effects",
      x = "Predictor", y = "Coefficient estimate",
      color = "Predictor", shape = "Predictor",
      caption = cap
    )
}

policy_models_unweighted <- fit_policy_models(df_policy_aapi, weighted = FALSE)
policy_models_weighted <- fit_policy_models(df_policy_aapi, weighted = TRUE)

p_policy_assoc_un <- plot_policy_assoc(
  policy_models_unweighted,
  "Policy preferences (AAPI only): key predictor comparison (unweighted)",
  weighted = FALSE
)

ggsave(
  here("outputs", "policy_association_comparison_unweighted.png"),
  p_policy_assoc_un,
  width = 12,
  height = 7
)

p_policy_assoc_w <- plot_policy_assoc(
  policy_models_weighted,
  "Policy preferences (AAPI only): key predictor comparison (weighted)",
  weighted = TRUE
)

ggsave(
  here("outputs", "policy_association_comparison_weighted.png"),
  p_policy_assoc_w,
  width = 12,
  height = 7
)
```

# Interaction term plots

```{r fig.width=10, fig.height=8}
# Extract interaction coefficients from all models
# Weighted only for concise plot
int_df <- map2_dfr(models_weighted, names(models_weighted), function(m, dv) {
  broom::tidy(m, conf.int = TRUE) %>%
    filter(str_detect(term, ":")) %>%
    mutate(dv = dv_labels[dv])
})

# Parse IV and race from interaction term names
int_df <- int_df %>%
  mutate(
    iv = case_when(
      str_detect(term, "discrimination") ~ "Discrimination",
      str_detect(term, "micro_aggression") ~ "Micro-aggression"
    ),
    race = str_extract(term, "AAPI|Latino|White")
  )

# Plot
p_int <- int_df %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = iv)) +
  geom_pointrange(position = position_dodge(width = 0.4), size = 0.6) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  coord_flip() +
  facet_wrap(~dv, scales = "free_x", ncol = 3) +
  scale_colour_Publication() +
  theme_Publication(base_size = 10) +
  labs(
    title = "Interaction effects (Weighted): Difference from Black respondents",
    subtitle = "Coefficients from pooled interaction models with state fixed effects",
    x = "Race", y = "Difference from Black", color = "IV",
    caption = "Source: National Asian American Survey (2016)"
  )
p_int

ggsave(here("outputs", "interaction_effects_weighted.png"), p_int, width = 10, height = 8)
```

# Within-group Wald tests

Test whether discrimination = micro-aggression within each racial group.

```{r}
race_levels <- c("Black", "AAPI", "Latino", "White")
models_for_wald <- models_weighted

wald_results <- map2_dfr(
  rep(names(models_for_wald), each = length(race_levels)),
  rep(race_levels, times = length(models_for_wald)),
  function(dv, rl) {
    test_disc_vs_micro(models_for_wald[[dv]], rl) %>%
      mutate(dv = dv_labels[dv])
  }
)

# Add significance stars
wald_results <- wald_results %>%
  mutate(
    sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ ""
    )
  )

# Format as table
wald_results %>%
  select(dv, race, estimate_diff, se_diff, z_stat, p_value, sig) %>%
  mutate(across(c(estimate_diff, se_diff, z_stat), ~round(., 3)),
         p_value = round(p_value, 4)) %>%
  kbl(
    col.names = c("DV", "Race", "Diff (Disc - Micro)", "SE", "z", "p", ""),
    caption = "Wald tests: Discrimination vs. Micro-aggression within racial groups"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

# Linked fate (ethnic): AAPI and Latino only

The `linkedfate_ethnic` variable is structurally missing for Black and White respondents. We fit a separate two-group model.

```{r}
df_ethnic <- df %>%
  filter(race %in% c("AAPI", "Latino")) %>%
  mutate(race = relevel(droplevels(race), ref = "AAPI"))

# Fit model (no interactions since only 2 groups, use race as covariate)
model_ethnic <- lm_robust(
  linkedfate_ethnic ~ discrimination * race + micro_aggression * race +
    age + educ6 + income + ownhome + male + forborn + democrat + republican,
  data = df_ethnic, fixed_effects = ~states
)

# Table
modelsummary(
  list("Linked fate (ethnic)" = model_ethnic),
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction model: Linked fate (ethnic), AAPI and Latino only",
  notes = "Reference category: AAPI. State fixed effects included.",
  output = here("outputs", "table_lf_ethnic.html")
)

modelsummary(
  list("Linked fate (ethnic)" = model_ethnic),
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction model: Linked fate (ethnic), AAPI and Latino only",
  notes = "Reference category: AAPI. State fixed effects included.",
  output = here("outputs", "table_lf_ethnic.tex")
)
```

```{r fig.width=8, fig.height=4}
# Marginal effects for ethnic linked fate
marginal_ethnic <- compute_marginal_effects(model_ethnic) %>%
  mutate(dv = "Linked fate (ethnic)")

p_ethnic <- marginal_ethnic %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term)) +
  geom_pointrange(position = position_dodge(width = 0.4), size = 0.6) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  coord_flip() +
  scale_colour_Publication() +
  theme_Publication(base_size = 10) +
  labs(
    title = "Linked fate (ethnic): AAPI vs. Latino",
    subtitle = "Marginal effects from pooled interaction model with state fixed effects",
    x = "Race", y = "Estimate", color = "IV",
    caption = "Source: National Asian American Survey (2016)"
  )
p_ethnic

ggsave(here("outputs", "marginal_lf_ethnic.png"), p_ethnic, width = 8, height = 4)
```

# Save Wald test table

```{r}
wald_results %>%
  select(dv, race, estimate_diff, se_diff, z_stat, p_value, sig) %>%
  mutate(across(c(estimate_diff, se_diff, z_stat), ~round(., 3)),
         p_value = round(p_value, 4)) %>%
  kbl(
    col.names = c("DV", "Race", "Diff (Disc - Micro)", "SE", "z", "p", ""),
    caption = "Wald tests: Discrimination vs. Micro-aggression within racial groups",
    format = "html"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  save_kable(here("outputs", "wald_tests.html"))
```
