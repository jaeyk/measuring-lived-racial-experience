---
title: "Pooled interaction models with formal tests"
author: "Jae Yeon Kim"
output:
  html_document:
    toc: true
    theme: united
---

# Setup

```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
        tidyverse, # for the tidyverse framework
        glue, # putting strings and objects together
        patchwork, # putting ggplots together
        conflicted, # for resolving conflicting functions
        here, # for self-contained projects
        ggpubr, # for pub-ready themes
        estimatr, # stat modeling
        modelsummary, # regression tables
        kableExtra # table formatting
)

# Resolve conflicts
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

# Publication-friendly theme
theme_set(theme_pubr(base_size = 10))

source(here("functions", "utils.r"))
source(here("functions", "theme_publications.r"))
```

# Data

```{r}
df <- read.csv(here("processed_data", "augmented_df.csv"))#[,-1]

# Filter Multiracial and relevel race with Black as reference
df <- df %>%
  filter(race != "Multiracial") %>%
  mutate(race = relevel(factor(race), ref = "Black"))

# Sample sizes by race
table(df$race)
```

# Fit pooled interaction models

```{r}
# DVs by family
dvs_lf <- c("linkedfate_race")
dvs_comm <- c("commrace", "commcult", "commecon", "commpol")
dvs_fed <- c("inequality", "bank_reg", "minimum_wage", "rich_tax", "free_college")
all_dvs <- c(dvs_lf, dvs_comm, dvs_fed)

# DV labels
dv_labels <- c(
  "linkedfate_race" = "Linked fate (racial)",
  "commrace" = "Racial commonality",
  "commcult" = "Cultural commonality",
  "commecon" = "Economic commonality",
  "commpol" = "Political commonality",
  "inequality" = "Reducing inequality",
  "bank_reg" = "Regulating banks",
  "minimum_wage" = "Minimum wage",
  "rich_tax" = "Taxing the rich",
  "free_college" = "Free college"
)

# Fit all models
# Fit all models
# Unweighted
models_unweighted <- map(all_dvs, ~ols_interaction(df, .x)) %>%
  set_names(all_dvs)
  
# Weighted
models_weighted <- map(all_dvs, ~ols_interaction(df, .x, weights = "weight")) %>%
  set_names(all_dvs)
```

# Regression tables

```{r}
# Coefficient map for clean labels
coef_map <- c(
  "discrimination" = "Discrimination",
  "micro_aggression" = "Micro-aggression",
  "raceAAPI" = "AAPI",
  "raceLatino" = "Latino",
  "raceWhite" = "White",
  "discrimination:raceAAPI" = "Discrimination × AAPI",
  "discrimination:raceLatino" = "Discrimination × Latino",
  "discrimination:raceWhite" = "Discrimination × White",
  "micro_aggression:raceAAPI" = "Micro-aggression × AAPI",
  "micro_aggression:raceLatino" = "Micro-aggression × Latino",
  "micro_aggression:raceWhite" = "Micro-aggression × White",
  "age" = "Age",
  "educ6" = "Education",
  "income" = "Income",
  "ownhome" = "Homeownership",
  "male" = "Male",
  "forborn" = "Foreign born",
  "democrat" = "Democrat",
  "republican" = "Republican"
)
```

## Linked fate

```{r}
# --- UNWEIGHTED Tables ---
# Linked fate
modelsummary(
  models_unweighted[dvs_lf],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Linked fate (Unweighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_lf_unweighted.html")
)
# Comm
modelsummary(
  models_unweighted[dvs_comm],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Community commonality (Unweighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_comm_unweighted.html")
)
# Fed
modelsummary(
  models_unweighted[dvs_fed],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Federal policy attitudes (Unweighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_fed_unweighted.html")
)

# --- WEIGHTED Tables ---
# Linked fate
modelsummary(
  models_weighted[dvs_lf],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Linked fate (Weighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_lf_weighted.html")
)
# Comm
modelsummary(
  models_weighted[dvs_comm],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Community commonality (Weighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_comm_weighted.html")
)
# Fed
modelsummary(
  models_weighted[dvs_fed],
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction models: Federal policy attitudes (Weighted)",
  notes = "Reference category: Black. State fixed effects included.",
  output = here("outputs", "table_fed_weighted.html")
)
```

# Marginal effects plots

```{r fig.width=10, fig.height=6}
# Compute marginal effects 
marginal_df_unweighted <- map2_dfr(models_unweighted, names(models_unweighted), function(m, dv) {
  compute_marginal_effects(m) %>%
    mutate(dv = dv_labels[dv])
})

marginal_df_weighted <- map2_dfr(models_weighted, names(models_weighted), function(m, dv) {
  compute_marginal_effects(m) %>%
    mutate(dv = dv_labels[dv])
})

# Plot function by DV family (reused)

# --- UNWEIGHTED Visualizations ---
p_lf_un <- marginal_df_unweighted %>%
  filter(dv %in% dv_labels[dvs_lf]) %>%
  plot_marginal("Linked fate (Unweighted)")
ggsave(here("outputs", "marginal_lf_unweighted.png"), p_lf_un, width = 8, height = 4)

p_comm_un <- marginal_df_unweighted %>%
  filter(dv %in% dv_labels[dvs_comm]) %>%
  plot_marginal("Community commonality (Unweighted)")
ggsave(here("outputs", "marginal_comm_unweighted.png"), p_comm_un, width = 10, height = 6)

p_fed_un <- marginal_df_unweighted %>%
  filter(dv %in% dv_labels[dvs_fed]) %>%
  plot_marginal("Federal policy attitudes (Unweighted)")
ggsave(here("outputs", "marginal_fed_unweighted.png"), p_fed_un, width = 12, height = 6)

# --- WEIGHTED Visualizations ---
p_lf_w <- marginal_df_weighted %>%
  filter(dv %in% dv_labels[dvs_lf]) %>%
  plot_marginal("Linked fate (Weighted)")
ggsave(here("outputs", "marginal_lf_weighted.png"), p_lf_w, width = 8, height = 4)

p_comm_w <- marginal_df_weighted %>%
  filter(dv %in% dv_labels[dvs_comm]) %>%
  plot_marginal("Community commonality (Weighted)")
ggsave(here("outputs", "marginal_comm_weighted.png"), p_comm_w, width = 10, height = 6)

p_fed_w <- marginal_df_weighted %>%
  filter(dv %in% dv_labels[dvs_fed]) %>%
  plot_marginal("Federal policy attitudes (Weighted)")
ggsave(here("outputs", "marginal_fed_weighted.png"), p_fed_w, width = 12, height = 6)
```

# Interaction term plots

```{r fig.width=10, fig.height=8}
# Extract interaction coefficients from all models
# Weighted only for concise plot
int_df <- map2_dfr(models_weighted, names(models_weighted), function(m, dv) {
  tidy(m, conf.int = TRUE) %>%
    filter(str_detect(term, ":")) %>%
    mutate(dv = dv_labels[dv])
})

# Parse IV and race from interaction term names
int_df <- int_df %>%
  mutate(
    iv = case_when(
      str_detect(term, "discrimination") ~ "Discrimination",
      str_detect(term, "micro_aggression") ~ "Micro-aggression"
    ),
    race = str_extract(term, "AAPI|Latino|White")
  )

# Plot
p_int <- int_df %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = iv)) +
  geom_pointrange(position = position_dodge(width = 0.4), size = 0.6) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  coord_flip() +
  facet_wrap(~dv, scales = "free_x", ncol = 3) +
  scale_colour_Publication() +
  theme_Publication(base_size = 10) +
  labs(
    title = "Interaction effects (Weighted): Difference from Black respondents",
    subtitle = "Coefficients from pooled interaction models with state fixed effects",
    x = "Race", y = "Difference from Black", color = "IV",
    caption = "Source: National Asian American Survey (2016)"
  )
p_int

ggsave(here("outputs", "interaction_effects_weighted.png"), p_int, width = 10, height = 8)
```

# Within-group Wald tests

Test whether discrimination = micro-aggression within each racial group.

```{r}
race_levels <- c("Black", "AAPI", "Latino", "White")

wald_results <- map2_dfr(
  rep(names(models), each = length(race_levels)),
  rep(race_levels, times = length(models)),
  function(dv, rl) {
    test_disc_vs_micro(models[[dv]], rl) %>%
      mutate(dv = dv_labels[dv])
  }
)

# Add significance stars
wald_results <- wald_results %>%
  mutate(
    sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01  ~ "**",
      p_value < 0.05  ~ "*",
      TRUE            ~ ""
    )
  )

# Format as table
wald_results %>%
  select(dv, race, estimate_diff, se_diff, z_stat, p_value, sig) %>%
  mutate(across(c(estimate_diff, se_diff, z_stat), ~round(., 3)),
         p_value = round(p_value, 4)) %>%
  kbl(
    col.names = c("DV", "Race", "Diff (Disc - Micro)", "SE", "z", "p", ""),
    caption = "Wald tests: Discrimination vs. Micro-aggression within racial groups"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

# Linked fate (ethnic): AAPI and Latino only

The `linkedfate_ethnic` variable is structurally missing for Black and White respondents. We fit a separate two-group model.

```{r}
df_ethnic <- df %>%
  filter(race %in% c("AAPI", "Latino")) %>%
  mutate(race = droplevels(race))

# Fit model (no interactions since only 2 groups, use race as covariate)
model_ethnic <- lm_robust(
  linkedfate_ethnic ~ discrimination * race + micro_aggression * race +
    age + educ6 + income + ownhome + male + forborn + democrat + republican,
  data = df_ethnic, fixed_effects = ~states
)

# Table
modelsummary(
  list("Linked fate (ethnic)" = model_ethnic),
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction model: Linked fate (ethnic), AAPI and Latino only",
  notes = "Reference category: AAPI. State fixed effects included.",
  output = here("outputs", "table_lf_ethnic.html")
)

modelsummary(
  list("Linked fate (ethnic)" = model_ethnic),
  coef_map = coef_map,
  stars = c("*" = 0.05, "**" = 0.01, "***" = 0.001),
  gof_omit = "IC|Log|Adj|F|RMSE",
  title = "Pooled interaction model: Linked fate (ethnic), AAPI and Latino only",
  notes = "Reference category: AAPI. State fixed effects included.",
  output = here("outputs", "table_lf_ethnic.tex")
)
```

```{r fig.width=8, fig.height=4}
# Marginal effects for ethnic linked fate
marginal_ethnic <- compute_marginal_effects(model_ethnic) %>%
  mutate(dv = "Linked fate (ethnic)")

p_ethnic <- marginal_ethnic %>%
  ggplot(aes(x = race, y = estimate, ymin = conf.low, ymax = conf.high, color = term)) +
  geom_pointrange(position = position_dodge(width = 0.4), size = 0.6) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  coord_flip() +
  scale_colour_Publication() +
  theme_Publication(base_size = 10) +
  labs(
    title = "Linked fate (ethnic): AAPI vs. Latino",
    subtitle = "Marginal effects from pooled interaction model with state fixed effects",
    x = "Race", y = "Estimate", color = "IV",
    caption = "Source: National Asian American Survey (2016)"
  )
p_ethnic

ggsave(here("outputs", "marginal_lf_ethnic.png"), p_ethnic, width = 8, height = 4)
```

# Save Wald test table

```{r}
wald_results %>%
  select(dv, race, estimate_diff, se_diff, z_stat, p_value, sig) %>%
  mutate(across(c(estimate_diff, se_diff, z_stat), ~round(., 3)),
         p_value = round(p_value, 4)) %>%
  kbl(
    col.names = c("DV", "Race", "Diff (Disc - Micro)", "SE", "z", "p", ""),
    caption = "Wald tests: Discrimination vs. Micro-aggression within racial groups",
    format = "html"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  save_kable(here("outputs", "wald_tests.html"))
```
